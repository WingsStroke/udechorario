<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Horarios Acad√©micos UdeC</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#ffffff;
  --fg:#000000;
  --gray:#f3f3f3;
}

*{
  box-sizing:border-box;
  font-family:"Inter", sans-serif;
}

body{
  margin:0;
  background:var(--bg);
  color:var(--fg);
}

.view{
  display:none;
  min-height:100vh;
  padding:30px;
}

.view.active{
  display:flex;
  flex-direction:column;
}

#home header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:15px;
}

#home header button{
  padding:10px 18px;
  background:#000;
  color:#fff;
  border:none;
  cursor:pointer;
  font-weight:600;
}

#sortBar{
  margin-bottom:20px;
}

#sortBar select{
  padding:6px 10px;
  border:1px solid #000;
  background:#fff;
  font-weight:600;
}

#scheduleList{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(220px,1fr));
  gap:15px;
}

.schedule-card{
  border:2px solid #000;
  padding:14px;
  cursor:pointer;
  transition:0.15s;
  position:relative;
}

.schedule-card:hover{
  background:#f5f5f5;
}

.schedule-card h3{
  margin:0;
  font-size:16px;
}

.schedule-card span{
  font-size:12px;
  color:#444;
}

.card-actions{
  position:absolute;
  top:6px;
  right:6px;
  display:flex;
  gap:4px;
}

.card-actions button{
  border:1px solid #000;
  background:#fff;
  font-size:12px;
  padding:2px 6px;
  cursor:pointer;
  font-weight:600;
}

#app header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:10px;
}

#app header button{
  padding:6px 15px;
  border:1px solid #000;
  background:#fff;
  cursor:pointer;
  font-weight:600;
}

.actions{
  display:flex;
  justify-content:flex-end;
  gap:10px;
  margin-bottom:10px;
}

.actions button{
  padding:8px 16px;
  background:#000;
  color:#fff;
  border:none;
  cursor:pointer;
  font-weight:600;
}

table{
  width:100%;
  border-collapse:collapse;
  table-layout:fixed;
}

th, td{
  border:1px solid #000;
  text-align:center;
  font-size:14px;
}

th{
  background:#000;
  color:#fff;
  padding:6px;
}

.time{
  font-weight:600;
  background:#f4f4f4;
  padding:6px;
}

.cell{
  cursor:pointer;
  position:relative;
  height:60px;
  padding: 0;
}

.cell:hover{
  background:#e6e6e6;
}

.subject {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  border-radius: 6px;
  color: white;
  font-size: 12px;
  cursor: pointer;
  display: flex;
  transition: height 0.15s ease, top 0.15s ease;
}

.subject-content {
  margin: 4px;
  border-radius: 6px;
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  text-align: center;
  padding: 4px;
  font-weight: bold;
}

.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.5);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:50;
}

.modal.active{
  display:flex;
}

.modal-content{
  background:#fff;
  border:2px solid #000;
  padding:20px 20px 24px 20px;
  width:320px;
  position:relative;
}


.modal-content h3{
  margin:0 0 10px 0;
}

.modal-content input,
.modal-content select{
  width:100%;
  padding:8px;
  border:1px solid #000;
  margin-top:4px;
}

.modal-content button{
  width:100%;
  padding:8px;
  background:#000;
  color:#fff;
  border:none;
  cursor:pointer;
  font-weight:600;
  margin-top:12px;
}

.close-btn{
  position:absolute;
  top:8px;
  right:12px;
  font-size:20px;
  font-weight:700;
  cursor:pointer;
  color:#000;
  user-select:none;
}

.close-btn:hover{
  color:#555;
}

.modal-content h3{
  padding-right:35px;
}

.ghost-subject{
  position:absolute;
  inset:4px;
  border-radius:6px;
  opacity:0.4;
  pointer-events:none;
}

.cell.blocked{
  border-top: none;
  pointer-events:none;
  background:#f0f0f0;
}
.input-error{
  border:2px solid #b00020 !important;
  background:#ffecec;
}

.error-text{
  color:#b00020;
  font-size:12px;
  margin-top:4px;
}

button:disabled{
  background:#999 !important;
  cursor:not-allowed;
  opacity:0.6;
}
.cell.active-cell {
  outline: 3px solid #46E563;
  outline-offset: -2px;
  background-color: rgba(70, 229, 99, 0.15);
}

.changelog-panel{
  position: fixed;
  top: 0;
  right: -360px;
  width: 360px;
  height: 100%;
  background: #ffffff;
  box-shadow: -4px 0 10px rgba(0,0,0,0.2);
  transition: right 0.3s ease;
  z-index: 9999;
  display: flex;
  flex-direction: column;
  font-family: inherit;
}

.changelog-panel.open{
  right: 0;
}

.changelog-header{
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 16px;
  background: #1e1e2f;
  color: white;
}

.changelog-header h2{
  margin: 0;
  font-size: 18px;
}

.changelog-header button{
  background: none;
  border: none;
  color: white;
  font-size: 20px;
  cursor: pointer;
}

.changelog-content{
  padding: 16px;
  overflow-y: auto;
  flex: 1;
}
.changelog-entry{
  border:1px solid #000;
  padding:12px;
  margin-bottom:12px;
  background:#f9f9f9;
}

.changelog-entry h3{
  margin:0 0 6px 0;
  font-size:15px;
}

.changelog-entry ul{
  margin:6px 0;
  padding-left:18px;
}

.changelog-entry li{
  font-size:13px;
  margin-bottom:4px;
}

.changelog-entry .date{
  font-size:12px;
  color:#444;
  margin-top:6px;
  font-weight:600;
}

</style>
</head>

<body>

<!--HOME-->
<div id="home" class="view active">
  <header>
    <h1>Mis Horarios</h1>
    <div style="display:flex; gap:10px;">
      <button id="createScheduleBtn">+ Nuevo horario</button>
      <button id="importSchedulesBtn">Importar</button>
      <input type="file" id="importFileInput" accept=".json" hidden>
      <button id="changelogBtn" style="position:relative;">
        Changelog
        <span id="changelogAlert" style="
          position:absolute;
          top:-4px;
          right:-4px;
          background:#b00020;
          color:white;
          border-radius:50%;
          width:16px;
          height:16px;
          font-size:11px;
          display:none;
          align-items:center;
          justify-content:center;
          font-weight:bold;
        ">!</span>
      </button>
    </div>
  </header>

  <div id="sortBar">
    <select>
  <option value="dateDesc">Fecha (m√°s reciente)</option>
  <option value="dateAsc">Fecha (m√°s antiguo)</option>
  <option value="nameAsc">Nombre (A-Z)</option>
  <option value="nameDesc">Nombre (Z-A)</option>
</select>
  </div>

  <div id="scheduleList">
    <!-- Cards de horarios -->
  </div>
</div>

<!--APP-->
<div id="app" class="view">
  <header>
    <h2>Horario actual</h2>
    <button>‚Üê Volver</button>
  </header>

  <div class="actions">
    <button id="exportScheduleBtn">Exportar JSON</button>
    <button id="exportPdfBtn">Exportar formato UdeC (PDF)</button>
    <button id="exportBtn">Exportar como imagen</button>
    <button id="calculateMonthlyBtn">Calcular Aguinaldo</button>
  </div>

  <div id="scheduleContainer">
  <table id="schedule">
    <thead>
      <tr>
        <th>Hora</th>
        <th>Lunes</th>
        <th>Martes</th>
        <th>Mi√©rcoles</th>
        <th>Jueves</th>
        <th>Viernes</th>
        <th>S√°bado</th>
      </tr>
    </thead>
    <tbody>
    </tbody>
  </table>
</div>
</div>

<!-- MODAL NUEVO HORARIO -->
<div class="modal" id="newScheduleModal">
  <div class="modal-content">
    <span class="close-btn">‚úï</span>
    <h3>Nuevo horario</h3>
    <label>Nombre del horario</label>
    <input type="text">
    <button>Guardar</button>
  </div>
</div>

<!--RENOMBRAR-->

<div class="modal" id="renameScheduleModal">
  <div class="modal-content">
    <span class="close-btn">‚úï</span>
    <h3>Renombrar horario</h3>
    <label>Nuevo nombre</label>
    <input type="text">
    <button>Guardar cambios</button>
  </div>
</div>

<!--ELIMINAR-->

<div class="modal" id="deleteScheduleModal">
  <div class="modal-content">
    <span class="close-btn">‚úï</span>
    <h3>Eliminar horario</h3>
    <p>¬øSeguro que deseas eliminar este horario?</p>
    <button>Eliminar</button>
  </div>
</div>

<!--ASIGNATURA-->

<div class="modal" id="subjectModal">
  <div class="modal-content">
    <span class="close-btn">‚úï</span>
    <h3>Asignatura</h3>

    <label>Nombre</label>
    <input type="text">

    <label>Grupo</label>
    <input type="text" id="subjectGroupInput" placeholder="Ej: A1">

    <label>Programa</label>
    <input type="text" id="subjectProgramInput" placeholder="Ej: Ingenier√≠a de Sistemas">

    <label>Color</label>
    <div style="display:flex;align-items:center;gap:10px;">
      <input type="color" id="subjectColorPicker">
      <div id="colorPreview" 
        style="width:28px;height:28px;border:2px solid #000;border-radius:4px;background:#1d4ed8;">
      </div>
    </div>


    <label>Bloques acad√©micos</label>
    <select>
  <option value="1">1 bloque</option>
  <option value="2">2 bloques</option>
  <option value="3">3 bloques</option>
  <option value="4">4 bloques</option>
</select>

    <button>Guardar asignatura</button>
  </div>
</div>

<!--MESADA-->

<div class="modal" id="monthlyModal">
  <div class="modal-content">
    <span class="close-btn">‚úï</span>
    <h3>Calcular Aguinaldo</h3>

    <label>Mes</label>
    <select id="monthSelect"></select>

    <label>A√±o</label>
    <input type="number" id="yearInput" min="2020" placeholder="Ej: 2026">
    <div class="error-text" id="yearError"></div>

    <label>Merienda diaria (COP)</label>
    <input type="number" id="snackCostInput" min="0" placeholder="Ej: 5000">
    <div class="error-text" id="snackError"></div>

    <label>Transporte ida + vuelta (COP)</label>
    <input type="number" id="transportCostInput" min="0" placeholder="Ej: 8000">
    <div class="error-text" id="transportError"></div>

    <label>M√≠nimo de bloques para hueco</label>
    <input type="number" id="gapBlocksInput" min="0" placeholder="Ej: 2">
    <div class="error-text" id="gapError"></div>

    <button id="confirmMonthlyCalculation">Calcular</button>
      <div id="monthlyResult" style="
        margin-top:12px;
        border-top:1px solid #000;
        padding-top:10px;
        display:none;
    ">
        <p id="resultMonth"></p>
        <p id="resultTrips"></p>
        <p id="resultTotal"></p>
        <button id="closeMonthlyResult">Cerrar</button>
</div>

  </div>
</div>

<div id="duplicateBar" style="
  position:fixed;
  top:0;
  left:0;
  right:0;
  background:#0066cc;
  color:white;
  padding:8px 12px;
  font-weight:600;
  display:none;
  z-index:100;
  justify-content:space-between;
  align-items:center;
">
  <span>Modo duplicaci√≥n activo: selecciona una celda</span>
  <button id="cancelDuplicateBtn" style="
    background:#fff;
    color:#0066cc;
    border:none;
    padding:4px 8px;
    font-weight:600;
    cursor:pointer;
  ">Cancelar</button>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<div id="changelogPanel" class="changelog-panel">
  <div class="changelog-header">
    <h2>Registro de cambios</h2>
    <button id="closeChangelogBtn">‚úï</button>
  </div>
  <div id="changelogContent" class="changelog-content">
    <!-- Aqu√≠ se renderizar√°n las versiones din√°micamente -->
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<script>

// PARTE 2

const monthlyModal = document.getElementById("monthlyModal");

const duplicateBar = document.getElementById("duplicateBar");
const cancelDuplicateBtn = document.getElementById("cancelDuplicateBtn");
const calculateBtn = document.getElementById("calculateMonthlyBtn");
const monthlyResult = document.getElementById("monthlyResult");
const resultMonth = document.getElementById("resultMonth");
const resultTrips = document.getElementById("resultTrips");
const resultTotal = document.getElementById("resultTotal");
const closeMonthlyResultBtn = document.getElementById("closeMonthlyResult");

const changelogBtn = document.getElementById("changelogBtn");
const changelogPanel = document.getElementById("changelogPanel");
const closeChangelogBtn = document.getElementById("closeChangelogBtn");
const changelogAlert = document.getElementById("changelogAlert");
const LAST_VERSION_KEY = "lastSeenChangelogVersion";

changelogBtn.addEventListener("click", async () => {
  changelogPanel.classList.add("open");
  await loadChangelog();

  const entries = document.querySelectorAll(".changelog-entry");
  if(entries.length > 0){
    const lastEntry = entries[entries.length - 1];
    const versionText = lastEntry.querySelector("h3").textContent;
    const version = versionText.replace("Versi√≥n ", "").trim();
    localStorage.setItem(LAST_VERSION_KEY, version);
    changelogAlert.style.display = "none";
  }
});

closeChangelogBtn.addEventListener("click", () => {
  changelogPanel.classList.remove("open");
});

closeMonthlyResultBtn.onclick = () => {
  monthlyResult.style.display = "none";
};

function renderChangelog(changelogData){
  const container = document.getElementById("changelogContent");
  container.innerHTML = "";

  changelogData.forEach(entry => {
    const card = document.createElement("div");
    card.className = "changelog-entry";

    const title = document.createElement("h3");
    title.textContent = `Versi√≥n ${entry.version}`;

    const list = document.createElement("ul");
    entry.changes.forEach(change => {
      const li = document.createElement("li");
      li.textContent = change;
      list.appendChild(li);
    });

    const date = document.createElement("div");
    date.className = "date";
    date.textContent = `Fecha de publicaci√≥n: ${entry.date}`;

    card.appendChild(title);
    card.appendChild(list);
    card.appendChild(date);

    container.appendChild(card);
  });
}

function checkChangelogVersion(changelogData){
  if(!Array.isArray(changelogData) || changelogData.length === 0) return;

  const latestVersion = changelogData[changelogData.length - 1].version;
  const lastSeenVersion = localStorage.getItem(LAST_VERSION_KEY);

  if(lastSeenVersion !== latestVersion){
    changelogAlert.style.display = "inline-flex";
  }else{
    changelogAlert.style.display = "none";
  }
}

async function loadChangelog(){

  try{
    const cacheBuster = Date.now();
    const response = await fetch(`changelog.json?v=${cacheBuster}`, {
      cache: "no-store"
    });
    const data = await response.json();

    renderChangelog(data);
    checkChangelogVersion(data);

    return data;
  }catch(err){
    console.error("Error cargando changelog:", err);
  }
}

function resetSubjectModalState(){
  duplicatingSubject = null;
  editingSubjectIndex = null;
  clearCurrentCell();
  setDuplicateCursor(false);
}

cancelDuplicateBtn.onclick = () => {
  resetSubjectModalState();
};

let schedules = JSON.parse(localStorage.getItem("schedules")) || [];
let currentScheduleIndex = null;

// ELEMENTOS HOME

const homeView = document.getElementById("home");
const appView = document.getElementById("app");
const scheduleList = document.getElementById("scheduleList");
const createScheduleBtn = document.getElementById("createScheduleBtn");
const sortSelect = document.querySelector("#sortBar select");

const nameModal = document.getElementById("newScheduleModal");
const renameModal = document.getElementById("renameScheduleModal");
const deleteModal = document.getElementById("deleteScheduleModal");

const scheduleNameInput = nameModal.querySelector("input");
const renameInput = renameModal.querySelector("input");

const confirmCreateBtn = nameModal.querySelector("button:not(.close-btn)");
const confirmRenameBtn = renameModal.querySelector("button:not(.close-btn)");
const confirmDeleteBtn = deleteModal.querySelector("button:not(.close-btn)");

let selectedScheduleIndex = null;

// GUARDAR EN LOCALSTORAGE

function saveData(){
  localStorage.setItem("schedules", JSON.stringify(schedules));
}

// RENDER DE HORARIOS FUNCIONA YA

function normalizeSubject(subject){
  return {
    id: subject.id || crypto.randomUUID(),
    name: subject.name || "",
    color: subject.color || "#1d4ed8",
    row: subject.row,
    col: subject.col,
    blocks: subject.blocks,
    group: subject.group || "",
    program: subject.program || ""
  };
}

function openSchedule(index){

  if(index === null || schedules[index] === undefined) return;

  currentScheduleIndex = index;
  scheduleTitle.textContent = schedules[index].name;

  homeView.classList.remove("active");
  appView.classList.add("active");

  schedules[index].subjects = schedules[index].subjects.map(normalizeSubject);
  saveData();
  buildScheduleTable();
}

function renderSchedules(){
  scheduleList.innerHTML = "";

  let sorted = [...schedules];

  switch(sortSelect.value){
    case "dateDesc":
      sorted.sort((a,b)=>b.created - a.created);
      break;
    case "dateAsc":
      sorted.sort((a,b)=>a.created - b.created);
      break;
    case "nameAsc":
      sorted.sort((a,b)=>a.name.localeCompare(b.name));
      break;
    case "nameDesc":
      sorted.sort((a,b)=>b.name.localeCompare(a.name));
      break;
  }

  sorted.forEach(schedule=>{
    const index = schedules.indexOf(schedule);

    const card = document.createElement("div");
    card.className = "schedule-card";

    card.innerHTML = `
      <h3>${schedule.name}</h3>
      <span>${new Date(schedule.created).toLocaleDateString()}</span>
      <div class="card-actions">
        <button data-action="rename">‚úé</button>
        <button data-action="delete">üóë</button>
      </div>
    `;

    card.onclick = (e)=>{
      if(e.target.dataset.action) return;
      openSchedule(index);
    };

    const renameBtn = card.querySelector('[data-action="rename"]');
    const deleteBtn = card.querySelector('[data-action="delete"]');

    renameBtn.onclick = ()=>{
      selectedScheduleIndex = index;
      renameInput.value = schedules[index].name;
      renameModal.classList.add("active");
    };

    deleteBtn.onclick = ()=>{
      selectedScheduleIndex = index;
      deleteModal.classList.add("active");
    };

    scheduleList.appendChild(card);
  });
}

// CREAR HORARIO BOBO POR FA FUNCIONA

createScheduleBtn.onclick = ()=>{
  scheduleNameInput.value = "";
  nameModal.classList.add("active");
};

confirmCreateBtn.onclick = ()=>{
  const name = scheduleNameInput.value.trim();
  if(!name) return alert("Debes escribir un nombre");

  schedules.push({
    name,
    created: Date.now(),
    subjects: []
  });

  saveData();
  nameModal.classList.remove("active");
  renderSchedules();
};

// RENOMBRAR HORARIO

confirmRenameBtn.onclick = ()=>{
  const name = renameInput.value.trim();
  if(!name) return;

  schedules[selectedScheduleIndex].name = name;
  saveData();
  renameModal.classList.remove("active");
  renderSchedules();
};

// ELIMINAR HORARIO

confirmDeleteBtn.onclick = ()=>{
  schedules.splice(selectedScheduleIndex,1);
  saveData();
  deleteModal.classList.remove("active");
  renderSchedules();
};

//CERRAR MODALES

document.querySelectorAll(".close-btn").forEach(btn=>{
  btn.onclick = ()=>{
    const modal = btn.closest(".modal");

    const duplicateBtn = modal.querySelector("#duplicateSubjectBtn");
    if(duplicateBtn) duplicateBtn.remove();

    modal.classList.remove("active");

    if(modal.id === "subjectModal"){
      resetSubjectModalState();
      subjectNameInput.value = "";
      subjectBlocksInput.value = "1";
    }
  };
});

// ORDENAMIENTO

sortSelect.onchange = ()=>{
  renderSchedules();
};

// ABRIR HORARIO

const backHomeBtn = document.querySelector("#app header button");
const scheduleTitle = document.querySelector("#app h2");

// VOLVER AL HOME

backHomeBtn.onclick = ()=>{
  appView.classList.remove("active");
  homeView.classList.add("active");
};

renderSchedules();

function enforceMinZero(input){
  input.addEventListener("input", () => {
    if (input.value < 0) input.value = 0;
  });
}

enforceMinZero(document.getElementById("snackCostInput"));
enforceMinZero(document.getElementById("transportCostInput"));
enforceMinZero(document.getElementById("gapBlocksInput"));

loadChangelog();

</script>

<script>

// PARTE 3

let editingSubjectIndex = null;
let cellMatrix = [];

// EXTRAER DIAS Y HORAS DE CELDA

const fullDays = [
  "Lunes",
  "Martes",
  "Mi√©rcoles",
  "Jueves",
  "Viernes",
  "S√°bado"
];

function getTimeFromRow(rowIndex) {
  const rows = document.querySelectorAll("#schedule tbody tr");

  if (!rows[rowIndex]) return null;

  const timeText = rows[rowIndex].querySelector(".time").textContent;
  const [start] = timeText.split(" - ");

  return {
    start: start.trim()
  };
}

function getEndTimeFromRow(rowIndex) {
  const rows = document.querySelectorAll("#schedule tbody tr");

  if (!rows[rowIndex]) return null;

  const timeText = rows[rowIndex].querySelector(".time").textContent;
  const [, end] = timeText.split(" - ");

  return end.trim();
}

function getSubjectScheduleText(subject) {
  const dayName = fullDays[subject.col];

  const startRow = subject.row;
  const endRow = subject.row + subject.blocks - 1;

  const startTime = getTimeFromRow(startRow)?.start;
  const endTime = getEndTimeFromRow(endRow);

  if (!startTime || !endTime) return "";

  return `${dayName} ${startTime} - ${endTime}`;
}

function buildSubjectsScheduleData() {
  if (currentScheduleIndex === null) return [];

  const schedule = schedules[currentScheduleIndex];
  const map = {};

  schedule.subjects.forEach(subject => {
    const scheduleText = getSubjectScheduleText(subject);

    const key = `${subject.name}||${subject.group}||${subject.program}`;

    if (!map[key]) {
      map[key] = {
      name: subject.name,
      group: subject.group || "",
      program: subject.program || "",
      times: []
      };
    }

    map[key].times.push(scheduleText);

  });

  return Object.values(map).map(item => ({
    name: item.name,
    schedule: item.times.join(" / "),
    group: item.group,
    program: item.program
  }));
}

function exportUniversityPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  const headers = [[
    "Asignatura",
    "Horario",
    "Grupo",
    "Programa"
  ]];

  const body = buildSubjectsScheduleData().map(item => [
    item.name,
    item.schedule,
    item.group || "",
    item.program || ""
  ]);

  doc.autoTable({
    startY: 10,
    head: headers,
    body: body,
    styles: {
      fontSize: 10,
      cellPadding: 3,
      valign: "middle",
      halign: "left",
      lineWidth: 0.2,
      lineColor: [0, 0, 0],
      textColor: [0, 0, 0]
    },
    headStyles: {
      fillColor: false,
      textColor: [0, 0, 0],
      fontStyle: "bold",
      lineWidth: 0.3,
      lineColor: [0, 0, 0]
    },
    bodyStyles: {
      fillColor: false
    },
    columnStyles: {
      0: { cellWidth: 40 },
      1: { cellWidth: 80 },
      2: { cellWidth: 25, halign: "center" },
      3: { cellWidth: 40 }
    },
    theme: "grid"
  });

  const fileName = "Formato_UdeC.pdf";
  doc.save(fileName);
}

// CONSTRUCCION TABLA

const scheduleBody = document.querySelector("#schedule tbody");

const monthSelect = document.getElementById("monthSelect");
const yearInput = document.getElementById("yearInput");

const snackInput = document.getElementById("snackCostInput");
const transportInput = document.getElementById("transportCostInput");
const gapInput = document.getElementById("gapBlocksInput");

[yearInput, snackInput, transportInput, gapInput].forEach(input => {
  input.addEventListener("input", updateCalculateButtonState);
});

const confirmMonthlyBtn = document.getElementById("confirmMonthlyCalculation");

function validateMonthlyInputs(showErrors = false){

  let valid = true;

  const year = document.getElementById("yearInput");
  const snack = document.getElementById("snackCostInput");
  const transport = document.getElementById("transportCostInput");
  const gap = document.getElementById("gapBlocksInput");

  const yearError = document.getElementById("yearError");
  const snackError = document.getElementById("snackError");
  const transportError = document.getElementById("transportError");
  const gapError = document.getElementById("gapError");

  [year, snack, transport, gap].forEach(i => {
    if(showErrors){
      i.classList.remove("input-error");
    }
  });

  [yearError, snackError, transportError, gapError].forEach(e => {
    if(showErrors){
      e.textContent = "";
    }
  });

  if(year.value !== ""){
    if(year.value < 2020){
      if(showErrors){
        year.classList.add("input-error");
        yearError.textContent = "El a√±o debe ser 2020 o mayor.";
      }
      valid = false;
    }
  } 
  else {
    valid = false;
  }

  if(snack.value === "" || snack.value < 0){
    if(showErrors){
      snack.classList.add("input-error");
      snackError.textContent = "La merienda no puede ser negativa.";
    }
    valid = false;
  }

  if(transport.value === "" || transport.value < 0){

    if(showErrors){
      transport.classList.add("input-error");
      transportError.textContent = "El transporte no puede ser negativo.";
    }
    valid = false;
  }

  if(gap.value === "" || gap.value < 0){

    if(showErrors){
      gap.classList.add("input-error");
      gapError.textContent = "El hueco m√≠nimo no puede ser negativo.";
    }
    valid = false;
  }

  return valid;
}

function updateCalculateButtonState(){
  const isValid = validateMonthlyInputs(false);
  confirmMonthlyBtn.disabled = !isValid;
}

confirmMonthlyBtn.onclick = () => {

  if(!validateMonthlyInputs(true)) return;

  const result = calculateMonthlyCost();

  if(!result) return;

  const monthName = months[monthSelect.value];
  const year = yearInput.value;

  resultMonth.textContent = `Mes calculado: ${monthName} ${year}`;
  resultTrips.textContent = `Total de viajes en el mes: ${result.trips}`;

  const snackFormatted = result.snackTotal.toLocaleString("es-CO");

  const oldSnack = monthlyResult.querySelector("#snackResult");
  if(oldSnack) oldSnack.remove();

  const resultSnack = document.createElement("p");
  resultSnack.id = "snackResult";
  resultSnack.textContent = `Total de merienda del mes: ${snackFormatted} COP`;

  monthlyResult.insertBefore(resultSnack, resultTotal);

  resultTotal.innerHTML = `
    Total del mes: <strong>${result.total.toLocaleString("es-CO")} COP</strong>
  `;

  monthlyResult.style.display = "block";
};

const months = [
  "Enero",
  "Febrero",
  "Marzo",
  "Abril",
  "Mayo",
  "Junio",
  "Julio",
  "Agosto",
  "Septiembre",
  "Octubre",
  "Noviembre",
  "Diciembre"
];

function populateMonths(){
  monthSelect.innerHTML = "";

  months.forEach((month, index) => {
    const option = document.createElement("option");
    option.value = index;
    option.textContent = month;
    monthSelect.appendChild(option);
  });

  const today = new Date();
  monthSelect.value = today.getMonth();
  yearInput.value = today.getFullYear();
}

populateMonths();

const subjectModal = document.getElementById("subjectModal");
const subjectNameInput = subjectModal.querySelector("input[type='text']");
const subjectGroupInput = document.getElementById("subjectGroupInput");
const subjectProgramInput = document.getElementById("subjectProgramInput");
const subjectColorInput = document.getElementById("subjectColorPicker");
const colorPreview = document.getElementById("colorPreview");
const subjectBlocksInput = subjectModal.querySelector("select");
const saveSubjectBtn = subjectModal.querySelector("button:not(.close-btn)");

function cleanSubjectModalButtons(){
  ["#deleteSubjectBtn", "#duplicateSubjectBtn"].forEach(id=>{
    const btn = subjectModal.querySelector(id);
    if(btn) btn.remove();
  });
}

function openSubjectModal(row, col){

  const cell = cellMatrix[row][col];

  if(cell.classList.contains("blocked")) return;

  setCurrentCell(row, col);
  editingSubjectIndex = null;

  subjectNameInput.value = "";
  subjectGroupInput.value = "";
  subjectProgramInput.value = "";
  subjectColorInput.value = "#1d4ed8";
  colorPreview.style.background = subjectColorInput.value;
  subjectBlocksInput.value = "1";
  saveSubjectBtn.textContent = "Guardar asignatura";

  cleanSubjectModalButtons();

  subjectModal.classList.add("active");

}

function buildScheduleTable(){

  scheduleBody.innerHTML = "";
  cellMatrix = [];

  const hours = [];
  let currentMinutes = 7 * 60;

  while (true) {
    if (currentMinutes === 12 * 60 + 50) {
      currentMinutes += 10;
    }

    const start = formatTime(currentMinutes);
    const endMinutes = currentMinutes + 50;
    const end = formatTime(endMinutes);

    hours.push(`${start} - ${end}`);
    currentMinutes = endMinutes;

    if (currentMinutes >= 18 * 60) break;
  }

  hours.forEach((h, row) => {
    const tr = document.createElement("tr");

    const timeTd = document.createElement("td");
    timeTd.textContent = h;
    timeTd.className = "time";
    tr.appendChild(timeTd);

    cellMatrix[row] = [];

    for(let col = 0; col < 6; col++){
      const td = document.createElement("td");
      td.className = "cell";
      td.dataset.row = row;
      td.dataset.col = col;

      cellMatrix[row][col] = td;

      td.onclick = () => {
        if(duplicatingSubject){
          placeDuplicatedSubject(row, col);
        } else {
          openSubjectModal(row, col);
        }
      };

      td.onmouseenter = () => {
        if(!duplicatingSubject) return;

        const oldGhost = td.querySelector(".ghost-subject");
        if(oldGhost) oldGhost.remove();

        const ghost = document.createElement("div");
        ghost.className = "ghost-subject";
        ghost.style.background = duplicatingSubject.color;
        ghost.textContent = duplicatingSubject.name;
        td.appendChild(ghost);
      };

      td.onmouseleave = () => {
        const ghost = td.querySelector(".ghost-subject");
        if(ghost) ghost.remove();
      };

      tr.appendChild(td);
    }

    scheduleBody.appendChild(tr);
  });

  renderSubjects();
}

function formatTime(totalMinutes){
  let hours = Math.floor(totalMinutes / 60);
  let minutes = totalMinutes % 60;

  const period = hours >= 12 ? "PM" : "AM";
  if (hours > 12) hours -= 12;
  if (hours === 0) hours = 12;

  return `${hours}:${minutes.toString().padStart(2,"0")} ${period}`;
}

calculateBtn.onclick = () => {
  monthlyModal.classList.add("active");
  updateCalculateButtonState();
};

// MODAL ASIGNATURA

let duplicatingSubject = null;

let currentCell = null;

function highlightCurrentCell(subject = null) {

  document
    .querySelectorAll(".cell.active-cell")
    .forEach(c => c.classList.remove("active-cell"));

  if (subject) {
    for (let i = 0; i < subject.blocks; i++) {
      const cell = cellMatrix[subject.row + i]?.[subject.col];
      if (cell) {
        cell.classList.add("active-cell");
      }
    }
    return;
  }

  if (!hasCurrentCell()) return;

  const { row, col } = currentCell;
  const cell = cellMatrix[row]?.[col];
  if (cell) {
    cell.classList.add("active-cell");
  }
}

function setCurrentCell(row, col){
  if (typeof row !== "number" || typeof col !== "number" || row < 0 || col < 0){

    clearCurrentCell();
    return;

  }

  currentCell = { row, col };
  highlightCurrentCell();
}

function clearCurrentCell(){
  currentCell = null;

  document
    .querySelectorAll(".cell.active-cell")
    .forEach(c => c.classList.remove("active-cell"));
}

function hasCurrentCell(){
  return currentCell !== null;
}

function setDuplicateCursor(active){
  document.body.style.cursor = active ? "copy" : "default";
  duplicateBar.style.display = active ? "flex" : "none";
}

function createDeleteButton(){
  const deleteBtn = document.createElement("button");
  deleteBtn.id = "deleteSubjectBtn";
  deleteBtn.textContent = "Eliminar asignatura";
  deleteBtn.style.background = "#b00020";
  deleteBtn.style.marginTop = "6px";
  deleteBtn.onclick = deleteSubject;
  return deleteBtn;
}

function createDuplicateButton(subject){
  const duplicateBtn = document.createElement("button");
  duplicateBtn.id = "duplicateSubjectBtn";
  duplicateBtn.textContent = "Duplicar asignatura";
  duplicateBtn.style.background = "#0066cc";
  duplicateBtn.style.marginTop = "6px";
  duplicateBtn.onclick = () => duplicateSubject(subject);
  return duplicateBtn;
}

function openEditSubjectModal(subject){

  resetSubjectModalState();

  editingSubjectIndex = schedules[currentScheduleIndex].subjects.findIndex(
    s => s.id === subject.id
  );

  setCurrentCell(subject.row, subject.col);

  subjectNameInput.value = subject.name;
  subjectGroupInput.value = subject.group || "";
  subjectProgramInput.value = subject.program || "";
  subjectColorInput.value = subject.color;
  colorPreview.style.background = subject.color;
  subjectBlocksInput.value = subject.blocks;

  subjectModal.classList.add("active");
  saveSubjectBtn.textContent = "Guardar cambios";

  const modalContent = subjectModal.querySelector(".modal-content");

  const oldDelete = modalContent.querySelector("#deleteSubjectBtn");
  if(oldDelete) oldDelete.remove();

  const oldDuplicate = modalContent.querySelector("#duplicateSubjectBtn");
  if(oldDuplicate) oldDuplicate.remove();

  modalContent.appendChild(createDeleteButton());
  modalContent.appendChild(createDuplicateButton(subject));

  highlightCurrentCell(subject);
}

subjectColorInput.oninput = () => {
  colorPreview.style.background = subjectColorInput.value;
};

// GUARDAR ASIGNATURA

function isCellOccupied(row, col, blocks, excludeSubject = null){
  const schedule = schedules[currentScheduleIndex];

  for(let i = 0; i < blocks; i++){
    const r = row + i;

    const conflict = schedule.subjects.some(s => {
      if (excludeSubject && s.id === excludeSubject.id) return false;

      for(let b = 0; b < s.blocks; b++){
        if(s.col === col && s.row + b === r){
          return true;
        }
      }
      return false;
    });

    if(conflict) return true;
  }

  return false;
}

saveSubjectBtn.onclick = () => {

  if(!hasCurrentCell()){
    alert("Primero selecciona una celda del horario.");
    return;
  }

  if(currentScheduleIndex === null) return;

  const name = subjectNameInput.value.trim();
  const color = subjectColorInput.value;
  const blocks = parseInt(subjectBlocksInput.value);

  if(!name) return alert("Nombre obligatorio");

  const schedule = schedules[currentScheduleIndex];

  let editingSubject = null;
  if(editingSubjectIndex !== null){
    editingSubject = schedule.subjects[editingSubjectIndex];
  }

  const maxRows = document.querySelectorAll("#schedule tbody tr").length;
  if(currentCell.row + blocks > maxRows){
    alert("La asignatura excede el horario disponible");
    return;
  }

  if(isCellOccupied(currentCell.row, currentCell.col, blocks, editingSubject)){
    alert("Ese espacio ya est√° ocupado por otra asignatura");
    return;
  }

  const newSubject = {
    id: editingSubject ? editingSubject.id : crypto.randomUUID(),
    name,
    color,
    row: currentCell.row,
    col: currentCell.col,
    blocks,
    group: subjectGroupInput.value.trim(),
    program: subjectProgramInput.value.trim()
  };

  if(editingSubjectIndex !== null){
    schedule.subjects.splice(editingSubjectIndex, 1);
  }

  schedule.subjects.push(newSubject);

  saveData();
  subjectModal.classList.remove("active");
  clearCurrentCell();
  editingSubjectIndex = null;
  saveSubjectBtn.textContent = "Guardar asignatura";

  cleanSubjectModalButtons();

  const duplicateBtn = subjectModal.querySelector("#duplicateSubjectBtn");
  if(duplicateBtn) duplicateBtn.remove();

  buildScheduleTable();
};

function deleteSubject(){
  const schedule = schedules[currentScheduleIndex];
  if(editingSubjectIndex === null) return;

  schedule.subjects.splice(editingSubjectIndex,1);
  saveData();

  subjectModal.classList.remove("active");
  clearCurrentCell();
  editingSubjectIndex = null;
  saveSubjectBtn.textContent = "Guardar asignatura";

  cleanSubjectModalButtons();

  const duplicateBtn = subjectModal.querySelector("#duplicateSubjectBtn");
  if(duplicateBtn) duplicateBtn.remove();

  buildScheduleTable();
}

function duplicateSubject(subject){
  subjectModal.classList.remove("active");
  clearCurrentCell();

  duplicatingSubject = {
    name: subject.name,
    color: subject.color,
    blocks: subject.blocks,
    group: subject.group || "",
    program: subject.program || ""
  };

  setDuplicateCursor(true);
}

setDuplicateCursor(false);

function placeDuplicatedSubject(row, col){
  const schedule = schedules[currentScheduleIndex];

  const blocks = duplicatingSubject.blocks;

  if(row + blocks > document.querySelectorAll("#schedule tbody tr").length){
    alert("La asignatura excede el horario disponible");
    duplicatingSubject = null;
    setDuplicateCursor(false);
    return;
  }

  if(isCellOccupied(row, col, blocks)){
    alert("Ese espacio ya est√° ocupado por otra asignatura");
    return;
  }

  const newSubject = {
    id: crypto.randomUUID(),
    name: duplicatingSubject.name,
    color: duplicatingSubject.color,
    row,
    col,
    blocks: duplicatingSubject.blocks,
    group: duplicatingSubject.group || "",
    program: duplicatingSubject.program || ""
  };

  schedule.subjects.push(newSubject);
  saveData();
  buildScheduleTable();
  resetSubjectModalState();

}

// DIBUJAR ASIGNATURAS

function getSubjectPixelHeight(subject){
  let height = 0;

  for(let i = 0; i < subject.blocks; i++){

    const cell = cellMatrix[subject.row + i]?.[subject.col];

    if(cell){
      height += cell.offsetHeight;
    }
  }

  return height;
}

function renderSubjects(){

  document.querySelectorAll(".subject").forEach(s => s.remove());
  document.querySelectorAll(".cell.blocked").forEach(c => {
    c.classList.remove("blocked");
  });

  if(currentScheduleIndex === null) return;

  const schedule = schedules[currentScheduleIndex];

  schedule.subjects.forEach(sub => {

    const baseCell = cellMatrix[sub.row]?.[sub.col];
    if(!baseCell) return;

    const div = document.createElement("div");
    div.className = "subject";

    const content = document.createElement("div");
    content.className = "subject-content";
    content.textContent = sub.name;
    content.style.background = sub.color;

    div.appendChild(content);

    div.style.position = "absolute";
    div.style.top = "0px";
    div.style.left = "0px";
  
    div.style.height = getSubjectPixelHeight(sub) + "px";
    div.style.boxSizing = "border-box";
    div.style.zIndex = "2";

    div.onclick = (e) => {
    e.stopPropagation();
    openEditSubjectModal(sub);
  };

for(let i = 1; i < sub.blocks; i++){

  const coveredCell = cellMatrix[sub.row + i]?.[sub.col];
  if(coveredCell){
    coveredCell.classList.add("blocked");
  }

} 

  baseCell.appendChild(div);

  });
}

function calculateDayCost(dayIndex, snackCost, transportCost, minGapBlocks){
  if(currentScheduleIndex === null) return { cost: 0, trips: 0 };

  const schedule = schedules[currentScheduleIndex];
  const daySubjects = schedule.subjects
    .filter(s => s.col === dayIndex)
    .sort((a,b) => a.row - b.row);

  if(daySubjects.length === 0){
    return { cost: 0, trips: 0 };
  }

  let trips = 1;

  if(minGapBlocks !== null && minGapBlocks > 0){
    for(let i = 0; i < daySubjects.length - 1; i++){
      const currentEnd = daySubjects[i].row + daySubjects[i].blocks;
      const nextStart = daySubjects[i + 1].row;
      const gap = nextStart - currentEnd;

      if(gap >= minGapBlocks){
        trips++;
      }
    }
  }

  const cost = snackCost + (transportCost * trips);

  return { cost, trips };
}

function getEasterDate(year){
  const f = Math.floor,
        G = year % 19,
        C = f(year / 100),
        H = (C - f(C / 4) - f((8 * C + 13) / 25) + 19 * G + 15) % 30,
        I = H - f(H / 28) * (1 - f(29 / (H + 1)) * f((21 - G) / 11)),
        J = (year + f(year / 4) + I + 2 - C + f(C / 4)) % 7,
        L = I - J,
        month = 3 + f((L + 40) / 44),
        day = L + 28 - 31 * f(month / 4);
  return new Date(year, month - 1, day);
}

function moveToMonday(date){
  const day = date.getDay();
  if(day === 1) return date;
  const diff = (8 - day) % 7;
  date.setDate(date.getDate() + diff);
  return date;
}

function generateColombianHolidays(year){
  const holidays = [];

  holidays.push(new Date(year, 4, 1));  // D√≠a del Trabajo (1 de mayo)
  holidays.push(new Date(year, 6, 20)); // Independencia
  holidays.push(new Date(year, 7, 7));  // Batalla de Boyac√°
  holidays.push(new Date(year, 11, 8)); // Inmaculada Concepci√≥n
  holidays.push(new Date(year, 11, 25)); // Navidad
  holidays.push(new Date(year, 0, 1)); // A√±o Nuevo

  holidays.push(moveToMonday(new Date(year, 0, 6))); // Epifan√≠a
  holidays.push(moveToMonday(new Date(year, 2, 19))); // San Jos√©
  holidays.push(moveToMonday(new Date(year, 5, 29))); // San Pedro y San Pablo
  holidays.push(moveToMonday(new Date(year, 7, 15))); // Asunci√≥n
  holidays.push(moveToMonday(new Date(year, 9, 12))); // D√≠a de la Raza
  holidays.push(moveToMonday(new Date(year, 10, 1))); // Todos los Santos
  holidays.push(moveToMonday(new Date(year, 10, 11))); // Independencia de Cartagena

  const easter = getEasterDate(year);

  const holyThursday = new Date(easter);
  holyThursday.setDate(easter.getDate() - 3);

  const goodFriday = new Date(easter);
  goodFriday.setDate(easter.getDate() - 2);

  holidays.push(holyThursday);
  holidays.push(goodFriday);

  const ascension = moveToMonday(new Date(easter.getTime() + 43 * 86400000));
  const corpusChristi = moveToMonday(new Date(easter.getTime() + 64 * 86400000));
  const sacredHeart = moveToMonday(new Date(easter.getTime() + 71 * 86400000));

  holidays.push(ascension);
  holidays.push(corpusChristi);
  holidays.push(sacredHeart);

  return holidays;
}

let holidayCache = {};

function isHoliday(date){
  const year = date.getFullYear();

  if(!holidayCache[year]){
    holidayCache[year] = generateColombianHolidays(year);
  }

  return holidayCache[year].some(h =>
    h.toDateString() === date.toDateString()
  );
}

function hasClassesThatDay(weekDayIndex){
  const schedule = schedules[currentScheduleIndex];
  return schedule.subjects.some(s => s.col === weekDayIndex);
}

function calculateMonthlyCost(){
  if(currentScheduleIndex === null) return;

  const month = parseInt(monthSelect.value);
  const year = parseInt(yearInput.value);

  const snackCost = parseFloat(document.getElementById("snackCostInput").value) || 0;
  const transportCost = parseFloat(document.getElementById("transportCostInput").value) || 0;
  const minGapBlocks = parseInt(document.getElementById("gapBlocksInput").value) || 0;

  let total = 0;
  let totalTrips = 0;
  let totalSnack = 0;

  const daysInMonth = new Date(year, month + 1, 0).getDate();

  for(let day = 1; day <= daysInMonth; day++){
    const date = new Date(year, month, day);
    const weekDay = date.getDay(); 

    if(weekDay === 0) continue;

    const scheduleDayIndex = weekDay - 1;

    if(isHoliday(date)) continue;

    if(!hasClassesThatDay(scheduleDayIndex)) continue;

    totalSnack += snackCost;

    const dayData = calculateDayCost(
      scheduleDayIndex,
      snackCost,
      transportCost,
      minGapBlocks > 0 ? minGapBlocks : null
    );

    total += dayData.cost;
    totalTrips += dayData.trips;

  }

  return {
    total,
    trips: totalTrips,
    snackTotal: totalSnack,
  };

}

// EXPORTAR JSON

document.getElementById("importSchedulesBtn").onclick = () => {
  document.getElementById("importFileInput").click();
};

document.getElementById("importFileInput").onchange = (e) => {
  const file = e.target.files[0];
  if(!file) return;

  const reader = new FileReader();
  reader.onload = (event) => {
    try {

      let imported = JSON.parse(event.target.result);

      if (!Array.isArray(imported)) {
        imported = [imported];
      }

      imported.forEach(schedule => {
        schedule.subjects = schedule.subjects.map(normalizeSubject);
      });

      imported.forEach(schedule => {
        const exists = schedules.some(s =>
          s.name === schedule.name && s.created === schedule.created
        );

        if (!exists) {
          schedules.push(schedule);
        }
      });

      saveData();
      renderSchedules();

      if (currentScheduleIndex !== null) {
        buildScheduleTable();
      }

      alert("Horarios importados correctamente.");
      document.getElementById("importFileInput").value = "";
    } 
    catch (err) {
      alert("Archivo inv√°lido o corrupto.");
      console.error(err);
    }
  };

  reader.readAsText(file);
};

document.getElementById("exportScheduleBtn").onclick = () => {
  if (currentScheduleIndex === null) {
    alert("No hay ning√∫n horario abierto para exportar.");
    return;
  }

  const schedule = schedules[currentScheduleIndex];

  const dataStr = JSON.stringify(schedule, null, 2);
  const blob = new Blob([dataStr], { type: "application/json" });

  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `horario_${schedule.name || "sin_nombre"}.json`;
  a.click();

  URL.revokeObjectURL(a.href);
};

// EXPORTAR FORMATO UdeC

document.getElementById("exportPdfBtn").addEventListener("click", exportUniversityPDF);

// EXPORTAR IMAGEN

document.getElementById("exportBtn").onclick = () => {
  const target = document.getElementById("scheduleContainer");

  if (currentScheduleIndex === null) return;

  let scheduleName = schedules[currentScheduleIndex].name;

  scheduleName = scheduleName
    .replace(/[\\/:*?"<>|]/g, "")
    .replace(/\s+/g, "_")
    .toLowerCase();

  html2canvas(target, {
    backgroundColor: "#ffffff",
    scale: 2
  }).then(canvas => {
    const link = document.createElement("a");
    link.href = canvas.toDataURL("image/png");
    link.download = `${scheduleName}.png`;
    link.click();
  });
};

if(currentScheduleIndex !== null){
  buildScheduleTable();
}

document.addEventListener("keydown", e => {
  if (e.key === "Escape" && duplicatingSubject) {
    duplicatingSubject = null;
    setDuplicateCursor(false);
  }
});

</script>

</body>
</html>
